# Linux file signer
Утилита, подписывающая содержимое архивов и .deb для Astra Linux/Debian

## Требования
+ bsign
+ gnupg
+ grep
+ python (3.5+)
+ unzip

## Использование
0. Установите необходимые для работы пакеты
   Для работы с пакетам wheel (Python) нужно установить пакет wheel версии 0.33.4
   ```
   pip install wheel==0.33.4
   ```
Для работы с пакетами jar (Java) нужно установить Bellsoft Liberica JDK 17. Под 8 версией не работает

1. Убедитесь что в системе не существует пользователя `signer`, он используется утилитой как временный пользователь для безопасного подписывания

2. Скопируйте директорию с ключами, полученную от заказчика (далее `KEY_DIR`), в домашнюю директорию пользователя 

3. Скопируйте в домашнюю директорию пользователя директорию с дистрибутивами для подписания (далее `REPO_DIR`). Файлы дистрибутивов могут быть ELF, архивами, или иметь иной тип. ПОдписание выполнятеся в том числе для вложенных архивов.

4. Выполните из-под текущего пользователя команды
   ```
   # chmod 0755 doroot.sh
   # chmod 0755 dononroot.sh
   # ./doroot.sh KEY_DIR REPO_DIR dononroot.sh BLACKLIST_FILE DIR_FOR_SIGNED
   ```
   `doroot.sh` создаст пользователя `signer` с правами 0700 на домашнюю диреткорию, добавил в данную директорию ключи и дистрибутивы для подписи, а также скопирует скрипт `dononroot.sh` в домашнюю директорию данного пользователя, затем запустит подписывание внутри пользователя `signer`, удалит из дистрибутива все файлы, в отн. путях которых встретится хоть одна строка из `BLACKLIST_FILE` (если не требуется, укажите `/dev/null`), и по окончании подписывания перенесет подписанные дистрибутивы в `DIR_FOR_SIGNED` и удалит все следы пользователя `signer`

## Подсказки
+ Файлы ELF подписываются с использованием своих заголовков и в любом случае не теряют свою подпись. Поддерживаемые ELF x86(-64) и ARM(64)
+ файлы not-ELF подписываются с помощью xattrs. Чтобы сохранить их при переносе репозитория на другие машины, вам следует упаковать и распаковать репозиторий в формате *.tar(.gz) с флагом `--xattrs`:
  ```
  (machine-1)# tar --xattrs -pczf /path/to/signed_repo.tar.gz /path/to/signer_repo
  ...
  (machine-2)# tar --xattrs -pxzf /path/to/signed_repo.tar.gz /path/to/signer_repo
  ```
+ Если ваш репозиторий содержит файлы *.tar.gz, они будут распакованы, рекурсивно подписаны внутри и автоматически переупакованы с использованием флага `--xattrs`. Пожалуйста, не забудьте об этом при распаковке.
+ архивы, отличные от tar (*.zip, *.rar), подписываются как обычные файлы, отличные от ELF (не распаковываются), поскольку они не могут хранить xattrs
+ Найти все ELF файлы в директории
  ```
  # find . -exec file {} \; | grep -i elf
  ```

## Проблемы
+ Пакеты *.deb не сохраняют свои xattrs при распаковке, поскольку dpkg-deb имеет встроенный распаковщик tar, который не поддерживает xattrs.
